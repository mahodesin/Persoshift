<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>PersoShift ETF‑Rechner</title>

  <!-- Schrift & Chart.js -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{font-family:'Inter',sans-serif;text-align:center;padding:2rem;max-width:960px;margin:auto;}
    h1{margin-bottom:1rem;font-size:2rem;}
    input,button{font-family:inherit;font-size:1rem;padding:0.45rem 0.6rem;border:1px solid #ccc;border-radius:6px;width:100%;box-sizing:border-box;}
    label{display:block;margin:0.6rem 0;text-align:left;}
    .row{display:flex;gap:0.6rem;}
    .btn{background:#5146ff;color:#fff;font-weight:600;border:none;cursor:pointer;border-radius:8px;margin:0.5rem 0;}
    .btn:hover{background:#3e37d8;}
    #advToggle{cursor:pointer;margin:1rem 0;text-decoration:underline;font-weight:600;}
    #advanced{display:none;border:1px dashed #bbb;padding:1rem;border-radius:8px;}
    canvas{width:100%!important;height:600px!important;}
    #warn{color:#c00;font-size:0.9rem;margin-top:0.3rem;min-height:1.2rem;}
  </style>
</head>
<body>

<h1>PersoShift ETF‑Rechner</h1>

<section style="text-align:left">
  <label>Monatsrate (€)
    <input id="rate" type="number" value="50" min="0">
  </label>
  <label>Laufzeit (Jahre)
    <input id="years" type="number" value="15" min="1">
  </label>
  <label>Jahresrendite (%)
    <input id="interest" type="number" value="7" step="0.1" min="0">
  </label>

  <div id="advToggle">Erweiterte Optionen ▼</div>
  <div id="advanced">
    <label>Startkapital (€)
      <input id="start" type="number" value="0" min="0">
    </label>
    <div class="row">
      <label style="flex:1">Einmalzahlung (€)
        <input id="lumpsum" type="number" value="0" min="0">
      </label>
      <label style="flex:1">ab Jahr
        <input id="lumpyear" type="number" value="1" min="1">
      </label>
    </div>
  </div>

  <button class="btn" onclick="calc(false)">Berechnen (Brutto)</button>
  <button class="btn" onclick="calc(true)">Berechnen (mit Steuer)</button>
  <div id="warn"></div>
</section>

<h2 id="headline"></h2>
<canvas id="chart"></canvas>

<h3>Vergleich (Endkapital)</h3>
<canvas id="compare"></canvas>

<script>
const taxRate = 0.26375;
let chartMain, chartCompare;

const $ = id => document.getElementById(id);
const fmt = n => n.toLocaleString('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:0});

// Toggle
$("advToggle").onclick = () => {
  const box = $("advanced");
  const open = box.style.display !== 'none';
  box.style.display = open ? 'none':'block';
  $("advToggle").textContent = open ? 'Erweiterte Optionen ▼' : 'Erweiterte Optionen ▲';
};

function calc(withTax){
  const rate   = +$("rate").value || 0;
  const yrs    = +$("years").value || 0;
  const pYear  = (+$("interest").value||0)/100;
  const start  = +$("start").value || 0;
  const lump   = +$("lumpsum").value || 0;
  const lumpY  = +$("lumpyear").value || 0;
  const warn   = $("warn");
  warn.textContent='';

  if(yrs<1){warn.textContent='Bitte Laufzeit ≥ 1 Jahr';return;}
  if(lump>0 && (lumpY<1||lumpY>yrs)){warn.textContent='Jahr für Einmalzahlung liegt außerhalb der Laufzeit';return;}

  const rM = pYear/12;
  let value = start;
  let paid  = start;

  const labels=[], depo=[], netArr=[], taxArr=[];
  for(let y=1;y<=yrs;y++){
    for(let m=0;m<12;m++){
      value = value*(1+rM) + rate; // Monate vorher verzinsen
    }
    if(lump>0 && y>=lumpY){ // Einmalzahlung addiert und ab jetzt verzinst
      if(y===lumpY){ value += lump; }
    }
    paid += rate*12 + (y===lumpY?lump:0);
    const gross = value - paid;
    const tax   = withTax ? gross*taxRate : 0;
    const net   = gross - tax;
    labels.push('Jahr '+y);
    depo.push(rate*12 + (y===lumpY?lump:0));
    netArr.push(net);
    taxArr.push(tax);
  }

  const endCap=value; const profit=endCap-paid;
  $("headline").textContent=`Endkapital: ${fmt(endCap)}   Einzahlungen: ${fmt(paid)}   Gewinn: ${fmt(profit)}`;
  drawChart(labels,depo,netArr,taxArr);
  drawCompare(endCap,paid,yrs);
}

function niceStep(max){
  const raw=max/6; const pow=Math.pow(10,Math.floor(Math.log10(raw)));
  return Math.ceil(raw/pow)*pow;
}

function drawChart(lbl,dep,net,tax){
  if(chartMain) chartMain.destroy();
  const combined=dep.map((v,i)=>v+net[i]+tax[i]);
  const maxY=Math.max(...combined);

  chartMain = new Chart($("chart"),{
    type:'bar',
    data:{labels:lbl,datasets:[
      {label:'Einzahlung',data:dep,backgroundColor:'#667aff',stack:'s',maxBarThickness:50},
      {label:'Gewinn (netto)',data:net,backgroundColor:'#2ecc71',stack:'s',maxBarThickness:50},
      {label:'Steuer',data:tax,backgroundColor:'#e74c3c',stack:'s',maxBarThickness:50}
    ]},
    options:{
      maintainAspectRatio:false,responsive:true,
      plugins:{legend:{position:'bottom',labels:{font:{size:16}}}},
      scales:{
        y:{beginAtZero:true,suggestedMax:maxY*1.2,
          ticks:{stepSize:niceStep(maxY),font:{size:16},callback:v=>v.toLocaleString('de-DE')}},
        x:{ticks:{font:{size:16}}}
      }
    }
  });
}

function drawCompare(end,paid,yrs){
  if(chartCompare) chartCompare.destroy();
  const bank0=paid;
  const tages=paid*Math.pow(1.02,yrs);
  const maxY=Math.max(end,bank0,tages);

  chartCompare = new Chart($("compare"),{
    type:'bar',
    data:{labels:['ETF','Bank 0 %','Tagesgeld 2 %'],datasets:[{
      data:[end,bank0,tages],backgroundColor:['#2ecc71','#95a5a6','#3498db'],maxBarThickness:50}]},
    options:{maintainAspectRatio:false,responsive:true,plugins:{legend:{display:false}},
      scales:{y:{beginAtZero:true,ticks:{stepSize:niceStep(maxY),font:{size:16},callback:v=>v.toLocaleString('de-DE')}},x:{ticks:{font:{size:16}}}}}
  });
}
</script>
</body>
</html>
