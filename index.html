<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>PersoShift ETF‚ÄëRechner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f9f9fa;
      --card-bg: #ffffff;
      --primary: #4A90E2;
      --primary-hover: #357ABD;
      --text: #333333;
      --muted: #666666;
      --border: #e0e0e0;
      --danger: #e74c3c;
      --success: #2ecc71;
      --payout-color-annual: rgba(39, 174, 96, 0.8); /* Green for annual payouts */
      --info-bg: #eef6ff;
      --secondary-btn-bg: #7f8c8d;
      --secondary-btn-hover-bg: #6c7a7d;
      --capital-color: #3498DB; 
      --gain-color: #F39C12;     
      --tax-color-diagram: rgba(231, 76, 60, 0.8); 
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { margin:0; background-color:var(--bg); color:var(--text); font-family:'Inter',sans-serif; line-height:1.6; font-size: 16px;}
    .container { max-width:800px; margin:1rem auto; padding:0 1rem; }

    .main-headline { text-align:center; font-size:2.5rem; margin-bottom:1rem; color: var(--primary); font-weight: 700;}

    .top-info-section {
      background-color: var(--card-bg); padding: 1.5rem; border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08); margin-bottom: 2rem;
    }
    .top-info-section h2 { font-size: 1.5rem; color: var(--primary); margin-top: 0; margin-bottom: 1rem; display: flex; align-items: center; }
    .top-info-section .toggle-button {
      background-color: var(--primary); color: white; border: none; padding: 0.5rem 1rem;
      border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600;
      transition: background-color 0.3s; margin-top: 1rem;
    }
    .top-info-section .toggle-button:hover { background-color: var(--primary-hover); }
    .top-info-content { display: none; margin-top: 1rem; font-size: 0.95rem; line-height: 1.7; }
    .top-info-content h3, .top-info-content h4 { font-size: 1.2rem; color: var(--text); margin-top: 1.5rem; margin-bottom: 0.5rem;}
    .top-info-content p, .top-info-content ul { margin-bottom: 1rem; }
    .top-info-content ul { padding-left: 20px; list-style-position: inside; } .top-info-content li { margin-bottom: 0.5rem; }
    .top-info-content strong { font-weight: 600; }
    .top-info-content .highlight { color: var(--success); font-weight: 600; }
    .top-info-content .warning { color: var(--danger); font-weight: 600; }
    .top-info-content .sub-list { padding-left: 20px; margin-top: 0.5rem;}
    .top-info-content .sub-list li {font-size: 0.9em;}
    .point-toggle { background: none; border: none; text-align: left; padding: 0; font-size: 1.2rem; font-weight: 600; color: var(--text); cursor: pointer; width: 100%;}
    .point-toggle::after { content: ' ‚ñº'; font-size: 0.8em; }
    .point-toggle.open::after { content: ' ‚ñ≤'; }
    .point-details { display: none; padding-left: 1rem; border-left: 2px solid var(--border); margin-top: 1rem;}


    h1 { text-align:center; font-size:2.2rem; margin-bottom:0.5rem; margin-top: 2rem; color: var(--primary); }
    .card { background:var(--card-bg); padding:2rem; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.1); margin-bottom:2rem; }
    label { display:block; margin:0.75rem 0 0.25rem; font-size:1rem; color:var(--text); font-weight: 500; }
    .label-group { display: flex; align-items: center; gap: 0.5rem;}
    input[type="number"], select, input[type="checkbox"] { width:100%; padding:0.7rem; font-size:1rem; border:1px solid var(--border); border-radius:8px; transition:border-color 0.3s; background-color: #fdfdff; }
    input[type="checkbox"] { width: auto; height: auto; margin-right: 0.5rem; vertical-align: middle;}
    input:focus, select:focus { border-color:var(--primary); outline:none; box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.25); }
    .row { display:flex; flex-wrap: wrap; gap:1rem; margin-top:0.5rem; align-items: flex-end; }
    .row > * { flex: 1; min-width: 130px; }
    .btn-group { display: flex; gap: 1rem; margin-top: 0.5rem; }
    .btn { display:block; width:100%; padding:0.8rem; margin:0; font-size:1.05rem; font-weight:600; color:#fff; background:var(--primary); border:none; border-radius:8px; cursor:pointer; transition:background 0.3s; }
    .btn:hover { background:var(--primary-hover); }
    .btn.active-calc-btn { background-color: var(--primary-hover); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
    .btn-secondary { background-color: var(--secondary-btn-bg); }
    .btn-secondary:hover { background-color: var(--secondary-btn-hover-bg); }
    .tax-note-container { display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 0.5rem; margin-bottom: 1rem;}
    .tax-note { font-size: 0.85rem; color: var(--muted); text-align: center; margin:0; }
    #advToggle { display:block; margin:1.5rem 0 1rem; font-size:1rem; font-weight:600; color:var(--primary); cursor:pointer; text-align: left; }
    #advanced { display:none; background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:1.5rem; margin-bottom:1rem; margin-top: 0.5rem; }
    #warn { color:var(--danger); font-size:0.95rem; min-height:1.2em; margin-top:0.5rem; text-align: center; font-weight: 500;}
    
    .headline-container { background-color: var(--info-bg); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; } 
    .headline-item { margin-bottom: 0.4rem; font-size: 1.05rem; display: flex; justify-content: space-between; align-items: center;}
    .headline-label { color: var(--muted); }
    .headline-value { font-weight: 600; color: var(--primary); }
    .headline-sub-value { color: var(--text); font-weight: 500; }
    .headline-item .info-btn { margin-left: 8px; } 


    h3 { text-align:center; margin-top:2.5rem; font-size:1.6rem; color: var(--text); }
    canvas { display:block; width:100% !important; max-width:800px; height:auto !important; aspect-ratio: 16 / 10; max-height: 500px; margin:0 auto 1.5rem; background:var(--card-bg); border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.05); } 
    
    .interest-rate-group { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    .interest-rate-group select { flex: 2 1 150px; }
    .interest-rate-group input[type="number"] { flex: 1 1 100px; }
    .info-button-group { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem; flex-wrap: wrap;}
    .info-btn {
      background-color: var(--muted); color: white; border: none; border-radius: 50%;
      width: 22px; height: 22px; font-size: 0.8rem; line-height: 22px; text-align: center;
      cursor: pointer; transition: background-color 0.2s; font-weight: bold;
      padding:0; display:inline-flex; justify-content:center; align-items:center;
    }
    .info-btn:hover { background-color: var(--primary); }
    .info-btn-label { font-size: 0.9rem; color: var(--muted); }

    .add-btn {
      background-color: var(--success); color: white; border: none; border-radius: 50%;
      width: 32px; height: 32px; font-size: 1.3rem; line-height: 32px; text-align: center;
      cursor: pointer; margin-top: 0.5rem; padding:0;
      transition: background-color 0.2s;
    }
    .add-btn:hover { background-color: #27ae60; }
    .remove-btn {
      background-color: var(--danger); color: white; border: none; border-radius: 4px;
      padding: 0.4rem 0.7rem; font-size: 0.85rem; cursor: pointer;
      height: fit-content; align-self: center; margin-left: 0.5rem;
    }
    .remove-btn:hover { background-color: #c0392b; }
    .dynamic-entry-row { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed var(--border); display: flex; gap: 0.5rem; align-items: flex-end;}
    .dynamic-entry-row > div { flex:1; }

    .inline-label { display: inline; margin-left: 0.25rem; font-weight: normal;}
    .form-group { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
    .form-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}

    .chart-controls { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 0.5rem; font-size: 0.9rem;}
    .chart-controls label { margin: 0 0.5rem 0 0; font-weight: normal; }
    .compare-options { display:flex; justify-content:center; gap:1rem; flex-wrap:wrap; margin-bottom:0.5rem; font-size:0.9rem; }
    .compare-options label { display:flex; align-items:center; gap:0.25rem; }
    .compare-options .legend-color { width:12px; height:12px; display:inline-block; border-radius:2px; }

    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0;
      width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
      align-items: center; justify-content: center;
    }
    .modal-content {
      background-color: var(--card-bg); margin: auto; padding: 25px; border-radius: 12px;
      width: 90%; max-width: 650px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      position: relative; animation: fadeInModal 0.3s ease-out;
    }
    @keyframes fadeInModal { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    .modal-close {
      color: var(--muted); float: right; font-size: 2rem; font-weight: bold;
      line-height: 1; cursor: pointer; transition: color 0.2s;
    }
    .modal-close:hover, .modal-close:focus { color: var(--danger); text-decoration: none; }
    .modal h2 { font-size: 1.5rem; color: var(--primary); margin-top: 0; margin-bottom: 1rem;}
    .modal p, .modal ul { font-size: 0.95rem; line-height: 1.7; color: var(--text); margin-bottom: 1rem;}
    .modal ul { padding-left: 20px; } .modal li { margin-bottom: 0.5rem; }
    .modal strong { font-weight: 600; }
    .modal pre { white-space: pre-wrap; background-color: var(--bg); padding: 1rem; border-radius: 8px; font-size: 0.9rem; }
  </style>
</head>
<body>

<div class="container">
  <h1 class="main-headline">PersoShift dein Helfer f√ºr Pers√∂nliche Entwicklung</h1>

  <div class="top-info-section">
    <h2>üíº Warum investieren?</h2>
    <div id="whyInvestContent" class="top-info-content">
        <!-- Dynamic content will be injected here by JavaScript -->
    </div>
    <button id="toggleWhyInvestBtn" class="toggle-button">Mehr erfahren</button>
  </div>

  <h1>ETF Sparplan-Rechner</h1>
  <div class="card">
    <label for="start">Startkapital (‚Ç¨)</label>
    <input id="start" type="number" value="0" min="0">
    
    <div class="row">
      <div style="flex: 2;">
        <div class="label-group">
          <label for="rate">Monatsrate (‚Ç¨)</label>
          <button type="button" class="info-btn" data-modal-target="modalMonthlyRate" title="Wieviel soll ich investieren?">?</button>
        </div>
        <input id="rate" type="number" value="100" min="0">
      </div>
      <div style="flex: 1;">
        <label for="currency">W√§hrung</label>
        <select id="currency">
          <option value="EUR" selected>Euro (EUR)</option>
          <option value="USD">US-Dollar (USD)</option>
          <option value="JPY">Japanischer Yen (JPY)</option>
          <option value="GBP">Britisches Pfund (GBP)</option>
          <option value="AUD">Australischer Dollar (AUD)</option>
        </select>
      </div>
    </div>

    <div class="row">
        <div style="flex:2">
            <label for="years">Laufzeit (Jahre)</label>
            <input id="years" type="number" value="40" min="1"> 
        </div>
        <div style="flex:1">
            <label for="startCalendarYear">Start-Kalenderjahr</label>
            <input type="number" id="startCalendarYear" value="" placeholder="z.B. 2025"> 
        </div>
    </div>

    <div>
      <label for="interestRatePreset">Jahresrendite (%)</label>
      <div class="interest-rate-group">
        <select id="interestRatePreset">
          <option value="10">Optimistisch 10%</option>
          <option value="7.6">Realistisch 7,6%</option> 
          <option value="5">Pessimistisch 5%</option>
          <option value="custom">Benutzerdefiniert</option>
        </select>
        <input type="number" id="interestCustom" step="0.1" min="0" style="display:none;" placeholder="z.B. 6.5">
      </div>
      <div class="info-button-group">
          <span class="info-btn-label">S&P500</span>
          <button type="button" class="info-btn" data-modal-target="modalSP500" title="Was ist der S&P 500?">?</button>
          <span class="info-btn-label" style="margin-left:10px;">MSCI World</span>
          <button type="button" class="info-btn" data-modal-target="modalMSCIWorld" title="Was ist der MSCI World?">?</button>
      </div>
    </div>

    <div class="form-group" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
        <div class="row">
            <div>
                <div class="label-group">
                    <label for="etfType">ETF-Typ:</label>
                    <button type="button" class="info-btn" data-modal-target="modalEtfTypeInfo" title="ETF-Typen Erkl√§rung">?</button>
                </div>
                <select id="etfType">
                    <option value="thesaurierend" selected>Thesaurierend</option>
                    <option value="ausschuettend">Aussch√ºttend</option> 
                </select>
            </div>
             <div>
                <div class="label-group">
                    <label for="basiszins">Basiszins p.a. (%):</label>
                     <button type="button" class="info-btn" data-modal-target="modalBasiszinsInfo" title="Was ist der Basiszins?">?</button>
                </div>
                <input type="number" id="basiszins" value="2.29" step="0.01" min="0"> 
            </div>
        </div>
        <div class="row">
            <div>
                 <div class="label-group">
                    <label for="freibetrag">J√§hrlicher Freibetrag (‚Ç¨):</label>
                    <button type="button" class="info-btn" data-modal-target="modalFreibetragInfo" title="Info zum Freibetrag">?</button>
                </div>
                <input type="number" id="freibetrag" value="1000" min="0"> 
            </div>
            <div>
                <div class="label-group">
                    <label for="steuerSatz">Steuersatz (inkl. Soli %):</label>
                    <button type="button" class="info-btn" data-modal-target="modalSteuersatzInfo" title="Info zum Steuersatz">?</button>
                </div>
                <input type="number" id="steuerSatz" value="26.375" step="0.001" min="0">
            </div>
        </div>
    </div>


    <div id="advToggle">Erweiterte Optionen ‚ñº</div>
    <div id="advanced">
      <div class="form-group">
        <h4 style="margin-bottom: 0.5rem; margin-top:0; font-weight:600; color:var(--primary);">Anpassung Monatsrate</h4>
        <div class="row">
            <div>
                <label for="monthlyRateIncrease">Monatsrate um x % p.a. erh√∂hen</label>
                <input id="monthlyRateIncrease" type="number" value="0" step="0.1" min="0">
            </div>
            <div>
                <input type="checkbox" id="stopMonthlyRateEnable">
                <label for="stopMonthlyRateEnable" class="inline-label">Monatsrate beenden?</label>
                <div id="stopMonthlyRateYearContainer" style="display:none; margin-top:0.5rem;">
                    <label for="stopMonthlyRateYear" style="font-size: 0.9rem;">Monatsrate stoppen ab Jahr (Laufjahr):</label>
                    <input type="number" id="stopMonthlyRateYear" min="1" value="10"> 
                </div>
            </div>
        </div>
      </div>
      
      <div class="form-group">
        <h4 style="margin-bottom: 0.5rem; margin-top:0; font-weight:600; color:var(--primary);">Einmalzahlungen</h4>
        <div id="lumpsumEntriesContainer">
          <div class="row main-entry-row">
            <div>
                <label for="lumpsum">Einmalige Einzahlung (‚Ç¨)</label>
                <input id="lumpsum" type="number" value="0" min="0" class="lumpsum-amount">
            </div>
            <div>
                <label for="lumpyear">Einmalige Einzahlung im Jahr (Laufjahr):</label>
                <input id="lumpyear" type="number" value="1" min="1" class="lumpsum-year">
            </div>
          </div>
        </div>
        <button type="button" id="addLumpsumBtn" class="add-btn">+</button> <small>Weitere Einmalzahlung hinzuf√ºgen</small>
      </div>
      
       <div class="form-group">
        <h4 style="margin-bottom: 0.5rem; margin-top:0; font-weight:600; color:var(--primary);">Datums-Eingabeart f√ºr Auszahlungen</h4>
        <div class="row">
            <div>
                 <div class="label-group">
                    <label for="payoutYearType">Jahr-Typ f√ºr Auszahlungen:</label>
                    <button type="button" class="info-btn" data-modal-target="modalDateTypeInfo" title="Laufjahr vs. Kalenderjahr">?</button>
                 </div>
                <select id="payoutYearType">
                    <option value="laufjahr" selected>Laufjahr</option>
                    <option value="kalenderjahr">Kalenderjahr</option>
                </select>
            </div>
        </div>
       </div>

      <div class="form-group">
        <h4 style="margin-bottom: 0.5rem; margin-top:0; font-weight:600; color:var(--primary);">Auszahlungen</h4>
        <div id="oneTimePayoutEntriesContainer">
           <div class="row main-entry-row">
               <div>
                <label>Einmalige Auszahlung (‚Ç¨)</label>
                <input id="payout" type="number" value="0" min="0" class="payout-amount">
               </div>
               <div>
                <label>Auszahlung im Jahr:</label>
                <input id="payoutYear" type="number" value="1" min="1" class="payout-year" placeholder="Jahr">
               </div>
           </div>
        </div>
        <button type="button" id="addOneTimePayoutBtn" class="add-btn">+</button> <small>Weitere einmalige Auszahlung hinzuf√ºgen</small>

        <div class="row" style="margin-top: 1.5rem;"> 
          <div>
              <label for="payoutPlanAmount">Auszahlplan Betrag (‚Ç¨)</label>
              <input id="payoutPlanAmount" type="number" value="0" min="0">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="payoutStartYear">Auszahlplan: Ab Jahr (Laufjahr)</label>
            <input id="payoutStartYear" type="number" value="1" min="1">
          </div>
          <div>
            <label for="payoutInterval">Auszahlplan: Intervall</label>
            <select id="payoutInterval">
              <option value="monthly">Monatlich</option>
              <option value="yearly">J√§hrlich</option>
              <option value="custom">Eigenes Intervall</option>
            </select>
          </div>
          <div>
            <label for="payoutIntervalDays">Auszahlintervall (Tage)</label>
            <input id="payoutIntervalDays" type="number" placeholder="Tage" disabled>
          </div>
        </div>
      </div>
    </div> 
    <button id="resetBtn" class="btn btn-secondary" style="margin-bottom: 0.75rem;">Alle Werte zur√ºcksetzen</button>
    <div class="btn-group">
        <button class="btn active-calc-btn" onclick="calc(false)">Berechnen (Brutto)</button>
        <button class="btn" onclick="calc(true)">Berechnen (Netto)</button>
    </div>
    <div class="tax-note-container">
        <p class="tax-note">Nettoberechnung abzgl. <span id="taxRateDisplay">26.375</span>% Kapitalertragsteuer + Soli (DE).</p>
        <button type="button" class="info-btn" data-modal-target="modalTaxInfo" title="Steuerdetails">?</button>
    </div>
    <div id="warn"></div>
  </div>

  <div id="headline" class="headline-container"></div> 
  <div class="chart-controls">
    <label for="chartAxisToggle">Diagramm-Achse: Kalenderjahre</label>
    <input type="checkbox" id="chartAxisToggle">
  </div>
  <canvas id="chart"></canvas>
  <h3 id="compareChartTitle">Vergleich (Gesamtwertentwicklung)</h3>
  <div class="compare-options">
    <label><input type="checkbox" class="asset-toggle" value="etf" checked><span class="legend-color" style="background-color:rgba(46,204,113,0.8)"></span> ETF</label>
    <label><input type="checkbox" class="asset-toggle" value="tagesgeld" checked><span class="legend-color" style="background-color:rgba(52,152,219,0.8)"></span> Tagesgeld 2%</label>
    <label><input type="checkbox" class="asset-toggle" value="bank" checked><span class="legend-color" style="background-color:rgba(149,165,166,0.8)"></span> Bank 0%</label>
    <label><input type="checkbox" class="asset-toggle" value="bitcoin"><span class="legend-color" style="background-color:rgba(247,147,26,0.8)"></span> Bitcoin</label>
    <label><input type="checkbox" class="asset-toggle" value="ethereum"><span class="legend-color" style="background-color:rgba(98,126,234,0.8)"></span> Ethereum</label>
  </div>
  <canvas id="compare"></canvas>
</div>

<div id="infoModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" data-close-modal>&times;</span>
    <h2 id="modalTitle">Info Titel</h2>
    <div id="modalBody"><p>Info Inhalt hier...</p></div>
  </div>
</div>

<script>
// Global variables for charts
let chartMain, chartCompare;

// Default values for resetting the form
const DEFAULT_MONTHLY_RATE = 100;
const DEFAULT_YEARS = 40;
const DEFAULT_INTEREST_PRESET = "7.6"; 
const DEFAULT_FREIBETRAG = 1000; 
const DEFAULT_STEUERSATZ = 26.375;
const DEFAULT_ETF_TYPE = "thesaurierend";
const DEFAULT_BASISZINS = 2.29; 
const DEFAULT_RATE_INCREASE = 0;
const DEFAULT_CURRENCY = 'EUR';

// Chart Colors
const CAPITAL_COLOR = 'rgba(52, 152, 219, 0.8)'; 
const GAIN_COLOR = 'rgba(243, 156, 18, 0.8)';     
const ANNUAL_PAYOUT_COLOR = 'rgba(39, 174, 96, 0.8)'; 
const TAX_COLOR_DIAGRAM = 'rgba(231, 76, 60, 0.7)';
const COMPARE_COLORS = {
    etf: 'rgba(46,204,113,0.8)',
    tagesgeld: 'rgba(52,152,219,0.8)',
    bank: 'rgba(149,165,166,0.8)',
    bitcoin: 'rgba(247,147,26,0.8)',
    ethereum: 'rgba(98,126,234,0.8)'
};

// Chart.js default settings
Chart.defaults.font.family = 'Inter, sans-serif';
Chart.defaults.font.size = 13;
Chart.defaults.plugins.legend.position = 'bottom';
Chart.defaults.maintainAspectRatio = false;
Chart.defaults.responsive = true;

// DOM Element references
const advToggle = document.getElementById('advToggle');
const advBox = document.getElementById('advanced');
const currencyEl = document.getElementById('currency');

// Formatting function for currency values
const fmt = (n, currency = 'EUR') => {
    let locale = 'de-DE'; // Default to German locale
    if (currency === 'USD') locale = 'en-US';
    if (currency === 'GBP') locale = 'en-GB';
    if (currency === 'JPY') locale = 'ja-JP';
    if (currency === 'AUD') locale = 'en-AU';

    return n.toLocaleString(locale, { style: 'currency', currency: currency, maximumFractionDigits: 0 });
};

// More DOM Elements
const rateEl = document.getElementById('rate');
const monthlyRateIncreaseEl = document.getElementById('monthlyRateIncrease'); 
const yearsEl = document.getElementById('years');
const startCalendarYearEl = document.getElementById('startCalendarYear');
const interestRatePresetEl = document.getElementById('interestRatePreset');
const interestCustomEl = document.getElementById('interestCustom');
const startEl = document.getElementById('start');
const warnEl = document.getElementById('warn');
const headlineEl = document.getElementById('headline');
const compareChartTitleEl = document.getElementById('compareChartTitle');
const etfTypeEl = document.getElementById('etfType');
const freibetragEl = document.getElementById('freibetrag');
const steuerSatzEl = document.getElementById('steuerSatz');
const basiszinsEl = document.getElementById('basiszins'); 
const taxRateDisplayEl = document.getElementById('taxRateDisplay');
const payoutYearTypeEl = document.getElementById('payoutYearType');
const stopMonthlyRateEnableEl = document.getElementById('stopMonthlyRateEnable');
const stopMonthlyRateYearContainerEl = document.getElementById('stopMonthlyRateYearContainer');
const stopMonthlyRateYearEl = document.getElementById('stopMonthlyRateYear');
const payoutPlanAmountEl = document.getElementById('payoutPlanAmount');
const payoutStartYearEl = document.getElementById('payoutStartYear');
const payoutIntervalEl = document.getElementById('payoutInterval');
const payoutIntervalDaysEl = document.getElementById('payoutIntervalDays');
const lumpsumEntriesContainer = document.getElementById('lumpsumEntriesContainer');
const oneTimePayoutEntriesContainer = document.getElementById('oneTimePayoutEntriesContainer');
const infoModal = document.getElementById('infoModal');
const modalTitleEl = document.getElementById('modalTitle');
const modalBodyEl = document.getElementById('modalBody');
const modalCloseBtns = document.querySelectorAll('[data-close-modal]');
const resetBtn = document.getElementById('resetBtn');
const chartAxisToggleEl = document.getElementById('chartAxisToggle');
const toggleWhyInvestBtn = document.getElementById('toggleWhyInvestBtn');
const whyInvestContent = document.getElementById('whyInvestContent');
const assetToggleEls = document.querySelectorAll('.asset-toggle');

// Data for informational modals
const modalData = { 
    modalSP500: {
        title: "Was ist der S&P 500?",
        content: `
            <p>Der S&P 500 ist ein Aktienindex, der die 500 gr√∂√üten b√∂rsennotierten US-Unternehmen abbildet. Er gilt als wichtiger Indikator f√ºr den US-Aktienmarkt.</p>
            <h3>Durchschnittliche Jahresrendite (p.a.)</h3>
            <p>Historisch lag die durchschnittliche Rendite bei ca. <strong>10% pro Jahr</strong> vor Inflation.</p>
            <p><strong>Wichtig:</strong> Vergangene Renditen sind keine Garantie f√ºr zuk√ºnftige Ergebnisse. Der Wert kann schwanken.</p>
            <p>Ein bekannter ETF ist der iShares Core S&P 500 UCITS ETF (<strong>ISIN: IE00B5BMR087</strong>).</p>
        `
    },
    modalMSCIWorld: {
        title: "Was ist der MSCI World?",
        content: `
            <p>Der MSCI World ist ein globaler Aktienindex, der ca. 1.500 Unternehmen aus 23 Industriel√§ndern umfasst. Er bietet eine breite internationale Streuung.</p>
            <h3>Durchschnittliche Jahresrendite (p.a.)</h3>
            <p>Langfristig lag die durchschnittliche Rendite bei ca. <strong>7-9% pro Jahr</strong> vor Inflation.</p>
            <p><strong>Wichtig:</strong> Auch hier sind vergangene Werte keine Garantie f√ºr die Zukunft und Schwankungen sind normal.</p>
            <p>Ein bekannter ETF ist der iShares Core MSCI World UCITS ETF (<strong>ISIN: IE00B4L5Y983</strong>).</p>
        `
    },
    modalMonthlyRate: {
        title: "Wieviel soll ich investieren?",
        content: `
            <p><strong>Wichtig ist: Regelm√§√üigkeit schl√§gt H√∂he.</strong></p>
            <p>Ein monatlicher ETF-Sparplan ab z.B. 100 ‚Ç¨ ist oft besser als gar nichts ‚Äì und l√§sst sich jederzeit anpassen.</p>
            <p>Eine g√§ngige Faustregel ist, <strong>10-15% des Nettoeinkommens</strong> f√ºr die Altersvorsorge zu investieren. Passen Sie den Betrag an Ihre pers√∂nliche finanzielle Situation an.</p>
        `
    },
    modalTaxInfo: {
        title: "Information zur Kapitalertragsteuer",
        content: `
            <p>In Deutschland unterliegen Kapitalertr√§ge (z.B. Zinsen, Dividenden, realisierte Kursgewinne) der Abgeltungsteuer.</p>
            <p>Der hier verwendete Satz von <strong>26,375%</strong> setzt sich zusammen aus:</p>
            <ul>
                <li>25% Abgeltungsteuer</li>
                <li>+ 5,5% Solidarit√§tszuschlag auf die Abgeltungsteuer (25% * 0,055 = 1,375%)</li>
            </ul>
            <p>(Ggf. kommt noch Kirchensteuer hinzu, diese ist hier nicht ber√ºcksichtigt.)</p>
            <p>Der <strong>Sparer-Pauschbetrag (Freibetrag)</strong> von derzeit 1.000 ‚Ç¨ pro Person kann auf Kapitalertr√§ge angerechnet werden.</p>
        `
    },
    modalEtfTypeInfo: {
        title: "ETF-Typen: Thesaurierend vs. Aussch√ºttend",
        content: `
            <h4>Thesaurierende ETFs:</h4>
            <p>Ertr√§ge (z.B. Dividenden) werden automatisch im Fondsverm√∂gen wiederangelegt. Dies f√ºhrt zu einem st√§rkeren Zinseszinseffekt. J√§hrlich wird eine <strong>Vorabpauschale</strong> als fiktiver Ertrag besteuert.</p>
            <h4>Aussch√ºttende ETFs:</h4>
            <p>Ertr√§ge werden direkt an die Anleger ausgezahlt. Diese Aussch√ºttungen sind im Jahr des Zuflusses steuerpflichtig (sofern sie den Freibetrag √ºbersteigen).</p>
        `
    },
    modalBasiszinsInfo: {
        title: "Was ist der Basiszins?",
        content: `
            <p>Der Basiszins wird von der Deutschen Bundesbank festgelegt und ist die Grundlage f√ºr die Berechnung der <strong>Vorabpauschale</strong> bei thesaurierenden ETFs.</p>
            <p>Die Formel (vereinfacht):<br>
            <em>Vorabpauschale = Fondswert zu Jahresbeginn √ó Basiszins √ó 0,7</em></p>
            <p>Der Basiszins f√ºr das Jahr 2024 wurde auf <strong>2,29%</strong> festgelegt.</p>
        `
    },
    modalVerkaufsteuerInfo: {
        title: "Verkaufsteuer bei Thesaurierenden ETFs",
        content: `
            <p>Die hier angezeigte "Verkaufsteuer (hypothetisch)" ist eine Sch√§tzung der Steuer, die anfallen w√ºrde, wenn das gesamte Depot am Ende der Laufzeit verkauft wird.</p>
            <p>Sie berechnet sich auf den Teil des Gewinns, der noch nicht durch die j√§hrlichen Vorabpauschalen versteuert wurde. Dies ist eine Vereinfachung.</p>
        `
    },
    modalFreibetragInfo: {
        title: "Was ist der j√§hrliche Freibetrag?",
        content: `
            <p>In Deutschland gibt es den <strong>Sparer-Pauschbetrag</strong>. Kapitalertr√§ge bis zu dieser H√∂he sind steuerfrei.</p>
            <ul>
                <li>F√ºr Einzelpersonen: <strong>1.000 ‚Ç¨ pro Jahr</strong></li>
                <li>F√ºr zusammenveranlagte Ehegatten: <strong>2.000 ‚Ç¨ pro Jahr</strong></li>
            </ul>
            <p>Nur der Teil der Ertr√§ge, der diesen Betrag √ºbersteigt, wird versteuert.</p>
        `
    },
    modalSteuersatzInfo: {
        title: "Information zum Steuersatz",
        content: `
            <p>Der Steuersatz auf Kapitalertr√§ge in Deutschland ist die <strong>Abgeltungsteuer</strong>.</p>
            <p>Der Standardsatz von <strong>26,375%</strong> setzt sich zusammen aus 25% Abgeltungsteuer + 5,5% Solidarit√§tszuschlag darauf.</p>
            <p>Falls Sie kirchensteuerpflichtig sind, erh√∂ht sich der Satz. Dies ist hier nicht standardm√§√üig ber√ºcksichtigt, Sie k√∂nnen den Satz aber manuell anpassen.</p>
        `
    },
    modalDateTypeInfo: {
        title: "Laufjahr vs. Kalenderjahr",
        content: `
            <p>Hier legen Sie fest, wie Jahresangaben bei Auszahlungen interpretiert werden.</p>
            <h4>Laufjahr</h4>
            <p>Bezieht sich auf das Investitionsjahr. 'Jahr 5' ist das f√ºnfte Jahr nach Investitionsstart.</p>
            <h4>Kalenderjahr</h4>
            <p>Bezieht sich auf ein spezifisches Kalenderjahr (z.B. 2035). Dies erfordert die Angabe eines Start-Kalenderjahres.</p>
        `
    }
};

// Functions to open and close modals
function openModal(targetId) { 
    const data = modalData[targetId];
    if (data && infoModal) {
        modalTitleEl.textContent = data.title;
        modalBodyEl.innerHTML = data.content;
        infoModal.style.display = 'flex';
    }
}
function closeModal() { 
    if (infoModal) infoModal.style.display = 'none';
}

// Event listeners for modals
document.querySelectorAll('[data-modal-target]').forEach(button => button.addEventListener('click', () => openModal(button.getAttribute('data-modal-target'))));
modalCloseBtns.forEach(button => button.addEventListener('click', closeModal));
window.addEventListener('click', (event) => { if (event.target === infoModal) closeModal(); });


// --- "Why Invest" section NEW LOGIC ---
function updateWhyInvestContent() {
    const currency = 'EUR'; // Examples are in EUR
    
    // Scenario 1: 100‚Ç¨/month for 40 years at 7%
    let balance1 = 0;
    let interestRate = 0.07;
    for (let i = 0; i < 40 * 12; i++) {
        balance1 += 100;
        balance1 *= (1 + interestRate / 12);
    }
    const totalDeposits1 = 100 * 12 * 40;
    const finalValue1 = balance1;

    // Scenario 2: Payouts from finalValue1
    const monthlyInterestGross = (finalValue1 * interestRate) / 12;
    const monthlyInterestNet = monthlyInterestGross * (1 - 0.26375);

    // Scenario 3: Annuity payout over 20 years
    const r_annuity = interestRate / 12;
    const n_annuity = 20 * 12;
    const annuityFactor = (r_annuity * Math.pow(1 + r_annuity, n_annuity)) / (Math.pow(1 + r_annuity, n_annuity) - 1);
    const monthlyAnnuity = finalValue1 * annuityFactor;

    // Scenario 4: Saving for 20 years to reach target
    const r_save = interestRate / 12;
    const n_save = 20 * 12;
    const futureValueFactor = (Math.pow(1 + r_save, n_save) - 1) / r_save;
    const requiredSaving = finalValue1 / futureValueFactor;

    // Scenario 5: 50k start + 100‚Ç¨/month for 20 years
    let balance5 = 50000;
    for (let i = 0; i < 20 * 12; i++) {
        balance5 += 100;
        balance5 *= (1 + interestRate / 12);
    }
    const finalValue5 = balance5;
    
    whyInvestContent.innerHTML = `
        <div class="info-point">
            <p>Die gesetzliche Rente allein reicht oft nicht aus, um den Lebensstandard im Alter zu halten. Private Vorsorge ist unerl√§sslich.</p>
            <button class="point-toggle" data-target="details-1">1. Die L√ºcke der gesetzlichen Rente</button>
            <div id="details-1" class="point-details">
                <p>Die Renteninformation zeigt nur die Bruttorente ‚Äì nicht, was am Ende wirklich auf dem Konto landet.</p>
                <h4>Beispiel: Kassierer mit 1.800 ‚Ç¨ brutto / 40 Jahre Arbeit</h4>
                <ul>
                    <li>Bruttorente (2050): ca. 1.415 ‚Ç¨/Monat</li>
                    <li>Abz√ºge:
                        <ul class="sub-list">
                            <li>Krankenversicherung (~ 8 %)</li>
                            <li>Pflegeversicherung (~ 3,4 ‚Äì 4 %)</li>
                            <li>Steuern (ab 2040: 100 % steuerpflichtig)</li>
                        </ul>
                    </li>
                    <li>Netto-Rente: ca. 1.050 ‚Äì 1.150 ‚Ç¨/Monat</li>
                    <li>Reale Kaufkraft (bei 2 % Inflation): <strong class="warning">nur ca. 650 ‚Äì 750 ‚Ç¨/Monat</strong></li>
                </ul>
                <p><strong class="warning">‚û° Fazit: Selbst nach einem Leben voller Arbeit droht Altersarmut.</strong></p>
            </div>
        </div>
        <div class="info-point">
            <p>Selbst kleine, regelm√§√üige Betr√§ge k√∂nnen √ºber lange Zeitr√§ume durch den Zinseszinseffekt zu einem erheblichen Verm√∂gen anwachsen.</p>
            <button class="point-toggle" data-target="details-2">2. ETF-Sparplan: 100 ‚Ç¨/Monat √ºber 40 Jahre</button>
            <div id="details-2" class="point-details">
                <ul>
                    <li>Einzahlung insgesamt: ${fmt(totalDeposits1, currency)}</li>
                    <li>Erwartetes Depotvolumen (bei 7 % Jahresrendite): <strong class="highlight">${fmt(finalValue1, currency)}</strong></li>
                </ul>
                <p>Damit hast du dir neben der gesetzlichen Rente ein weiteres Polster aufgebaut.</p>
            </div>
        </div>
        <div class="info-point">
            <p>Ein aufgebautes Verm√∂gen bietet finanzielle Flexibilit√§t, sei es f√ºr eine fr√ºhere Rente, gr√∂√üere Anschaffungen oder einfach zur Absicherung.</p>
            <button class="point-toggle" data-target="details-3">3. Was bringt das konkret?</button>
            <div id="details-3" class="point-details">
                <h4>Zusatz-Rente durch Entnahmen (Kapital erhalten)</h4>
                <ul>
                    <li>Kapital nach 40 Jahren: ${fmt(finalValue1, currency)}</li>
                    <li>Monatlicher Nettozins (nach Steuern): <strong class="highlight">${fmt(monthlyInterestNet, currency)}</strong></li>
                </ul>
                <p>Bedeutung: Du kannst dir diesen Betrag pro Monat auszahlen lassen, ohne dein Kapital anzutasten.</p>
                <h4>Alternativ: Kapital planm√§√üig aufbrauchen (nach 20 Jahren leer)</h4>
                <ul>
                    <li>Monatliche Entnahme (brutto): <strong class="highlight">${fmt(monthlyAnnuity, currency)}</strong></li>
                </ul>
                <p>Ergebnis: Nach 20 Jahren ist das Depot leer ‚Äì du hast es vollst√§ndig in monatliche Zahlungen umgewandelt.</p>
            </div>
        </div>
        <div class="info-point">
             <p>Auch ein sp√§terer Einstieg lohnt sich. H√∂here Sparraten oder ein Startkapital k√∂nnen die k√ºrzere Laufzeit ausgleichen.</p>
            <button class="point-toggle" data-target="details-4">4. Beispiele f√ºr ‚Äû√§ltere‚Äú Anleger</button>
            <div id="details-4" class="point-details">
                <h4>Du bist 40 Jahre alt und willst mit 60 finanziell sorgenfrei sein?</h4>
                 <ul>
                    <li>Ziel: ${fmt(finalValue1, currency)} Kapital im Depot.</li>
                    <li>N√∂tige monatliche Sparrate (20 Jahre, 7% p.a.): <strong class="highlight">${fmt(requiredSaving, currency)}</strong></li>
                </ul>
                <h4>Oder: 50.000 ‚Ç¨ Startkapital + 100 ‚Ç¨ monatlich</h4>
                 <ul>
                    <li>Ergebnis nach 20 Jahren: <strong class="highlight">${fmt(finalValue5, currency)}</strong></li>
                </ul>
            </div>
        </div>
         <div class="info-point">
            <button class="point-toggle" data-target="details-5">5. Was bringt das konkret (Zusammenfassung)?</button>
            <div id="details-5" class="point-details">
                 <ul>
                    <li>Rente allein reicht oft nicht ‚Äì private Vorsorge ist essenziell.</li>
                    <li>ETF-Sparplan ab 100 ‚Ç¨ im Monat kann nach 40 Jahren √ºber <strong class="highlight">${fmt(240000, currency)}</strong> bringen.</li>
                    <li>Das erm√∂glicht z.B. √ºber <strong class="highlight">${fmt(1000, currency)} Netto extra</strong> pro Monat auf lange Sicht.</li>
                    <li>Wer fr√ºh und regelm√§√üig beginnt, gewinnt im Alter Freiheit, Sicherheit und W√ºrde.</li>
                </ul>
            </div>
        </div>
    `;
}

if (toggleWhyInvestBtn && whyInvestContent) { 
    toggleWhyInvestBtn.addEventListener('click', () => {
        const isHidden = whyInvestContent.style.display === 'none' || whyInvestContent.style.display === '';
        if (isHidden) {
            updateWhyInvestContent();
            whyInvestContent.style.display = 'block';
        } else {
            whyInvestContent.style.display = 'none';
        }
        toggleWhyInvestBtn.textContent = isHidden ? 'Weniger anzeigen' : 'Mehr erfahren';
    });

    whyInvestContent.addEventListener('click', function(e) {
        if (e.target.classList.contains('point-toggle')) {
            const button = e.target;
            const targetId = button.dataset.target;
            const details = document.getElementById(targetId);
            if (details) {
                button.classList.toggle('open');
                details.style.display = details.style.display === 'block' ? 'none' : 'block';
            }
        }
    });
}

const labelTexts = {
    'start': 'Startkapital',
    'rate': 'Monatsrate',
    'freibetrag': 'J√§hrlicher Freibetrag',
    'lumpsum': 'Einmalige Einzahlung',
    'payout': 'Einmalige Auszahlung',
    'payoutPlanAmount': 'Auszahlplan Betrag'
};


function updateCurrencyLabels(currencyCode) {
    const symbolMap = { 'EUR': '‚Ç¨', 'USD': '$', 'JPY': '¬•', 'GBP': '¬£', 'AUD': 'A$' };
    const symbol = symbolMap[currencyCode] || currencyCode;

    for (const forAttr in labelTexts) {
        const label = document.querySelector(`label[for="${forAttr}"]`);
        if (label) {
            label.textContent = `${labelTexts[forAttr]} (${symbol})`;
        }
    }
    
    document.querySelectorAll('#oneTimePayoutEntriesContainer .main-entry-row label').forEach(label => {
      if(label.textContent.includes('Einmalige Auszahlung')) {
        label.textContent = `Einmalige Auszahlung (${symbol})`;
      }
    });
    document.querySelectorAll('#lumpsumEntriesContainer .main-entry-row label').forEach(label => {
        if(label.textContent.includes('Einmalige Einzahlung')) {
            label.textContent = `Einmalige Einzahlung (${symbol})`;
        }
    });
     document.querySelectorAll('#payoutPlanAmount').forEach(label => {
        if(label.parentElement.querySelector('label')) {
            label.parentElement.querySelector('label').textContent = `Auszahlplan Betrag (${symbol})`;
        }
    });
}

advToggle.onclick = () => {
    const open = advBox.style.display === 'block';
    advBox.style.display = open ? 'none' : 'block';
    advToggle.textContent = open ? 'Erweiterte Optionen ‚ñº' : 'Erweiterte Optionen ‚ñ≤';
};
interestRatePresetEl.addEventListener('change', function() {
    interestCustomEl.style.display = this.value === 'custom' ? 'block' : 'none';
    if (this.value === 'custom') {
        interestCustomEl.focus();
        if (!interestCustomEl.value) interestCustomEl.value = "7.6";
    }
});
currencyEl.addEventListener('change', () => {
    const newCurrency = currencyEl.value;
    updateCurrencyLabels(newCurrency);
    const activeCalcButton = document.querySelector('.btn-group .btn.active-calc-btn');
    const isNetto = activeCalcButton && activeCalcButton.textContent.includes('Netto');
    calc(isNetto);
});
stopMonthlyRateEnableEl.addEventListener('change', function() {
    stopMonthlyRateYearContainerEl.style.display = this.checked ? 'block' : 'none';
});
payoutIntervalEl.addEventListener('change', function() {
    payoutIntervalDaysEl.disabled = this.value !== 'custom';
    if (this.value === 'custom' && !payoutIntervalDaysEl.value) {
        payoutIntervalDaysEl.value = '30';
    } else if (this.value !== 'custom') {
        payoutIntervalDaysEl.value = '';
    }
});
steuerSatzEl.addEventListener('input', function() {
    taxRateDisplayEl.textContent = this.value || DEFAULT_STEUERSATZ.toString();
});

function addDynamicEntry(container, typeClassAmount, typeClassYear) {
    const newEntryRow = document.createElement('div');
    newEntryRow.className = 'row dynamic-entry-row';
    const amountDiv = document.createElement('div');
    const amountInput = document.createElement('input');
    amountInput.type = 'number';
    amountInput.min = '0';
    amountInput.value = '0';
    amountInput.className = typeClassAmount;
    const currency = currencyEl.value;
    const symbolMap = {
        'EUR': '‚Ç¨',
        'USD': '$',
        'JPY': '¬•',
        'GBP': '¬£',
        'AUD': 'A$'
    };
    amountInput.placeholder = `Betrag (${symbolMap[currency] || currency})`;
    amountDiv.appendChild(amountInput);
    const yearDiv = document.createElement('div');
    const yearInput = document.createElement('input');
    yearInput.type = 'number';
    yearInput.min = '1';
    yearInput.value = '1';
    yearInput.className = typeClassYear;
    yearInput.placeholder = "Jahr";
    yearDiv.appendChild(yearInput);
    newEntryRow.appendChild(amountDiv);
    newEntryRow.appendChild(yearDiv);

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = 'X';
    removeBtn.className = 'remove-btn';
    removeBtn.onclick = () => newEntryRow.remove();
    newEntryRow.appendChild(removeBtn);
    container.appendChild(newEntryRow);
}
document.getElementById('addLumpsumBtn').addEventListener('click', () => addDynamicEntry(lumpsumEntriesContainer, 'lumpsum-amount', 'lumpsum-year'));
document.getElementById('addOneTimePayoutBtn').addEventListener('click', () => addDynamicEntry(oneTimePayoutEntriesContainer, 'payout-amount', 'payout-year'));

function getDynamicEntries(amountClass, yearClass) {
    const amounts = document.querySelectorAll(`.${amountClass}`);
    const years = document.querySelectorAll(`.${yearClass}`);
    const entries = [];
    for (let i = 0; i < amounts.length; i++) {
        const amount = parseFloat(amounts[i].value) || 0;
        const yearVal = parseInt(years[i].value) || 0;
        if (amount > 0 && yearVal > 0) {
            entries.push({
                amount,
                year: yearVal
            });
        }
    }
    return entries;
}

function computeComparisonTotal(start, lumpsums, baseRate, rateIncrease, annualRate, years, stopEnabled, stopYear) {
    let total = start;
    lumpsums.forEach(lump => { if (lump.amount > 0) total += lump.amount; });
    let dynRate = baseRate;
    for (let y = 1; y <= years; y++) {
        if (y > 1) dynRate *= (1 + rateIncrease);
        const yearlyContrib = (stopEnabled && y >= stopYear) ? 0 : dynRate * 12;
        total += yearlyContrib;
        total *= (1 + annualRate);
    }
    return total;
}

function updateCompareChart(etfTotal, tdTotal, bankTotal, btcTotal, ethTotal, currency) {
    if (chartCompare) chartCompare.destroy();
    const selected = Array.from(document.querySelectorAll('.asset-toggle:checked')).map(cb => cb.value);
    const labels = [];
    const data = [];
    const colors = [];
    if (selected.includes('etf')) { labels.push('ETF (Gesamtwertentwicklung)'); data.push(etfTotal); colors.push(COMPARE_COLORS.etf); }
    if (selected.includes('tagesgeld')) { labels.push('Tagesgeld 2%'); data.push(tdTotal); colors.push(COMPARE_COLORS.tagesgeld); }
    if (selected.includes('bank')) { labels.push('Bank 0% (Einzahlungen)'); data.push(bankTotal); colors.push(COMPARE_COLORS.bank); }
    if (selected.includes('bitcoin')) { labels.push('Bitcoin'); data.push(btcTotal); colors.push(COMPARE_COLORS.bitcoin); }
    if (selected.includes('ethereum')) { labels.push('Ethereum'); data.push(ethTotal); colors.push(COMPARE_COLORS.ethereum); }

    compareChartTitleEl.textContent = 'Vergleich (Gesamtwertentwicklung)';
    chartCompare = new Chart(document.getElementById('compare').getContext('2d'), {
        type: 'bar',
        data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, barPercentage: 0.7 }] },
        options: {
            ...chartOptionsBase,
            scales: { y: { title: { display: true, text: `Gesamtwert (${currency.toUpperCase()})`}}},
            plugins: { ...chartOptionsBase.plugins, legend: { display: false } }
        }
    });
}

function resetValuesAndCalc() {
    currencyEl.value = DEFAULT_CURRENCY;
    rateEl.value = DEFAULT_MONTHLY_RATE;
    monthlyRateIncreaseEl.value = DEFAULT_RATE_INCREASE;
    yearsEl.value = DEFAULT_YEARS;
    startCalendarYearEl.value = new Date().getFullYear();
    interestRatePresetEl.value = DEFAULT_INTEREST_PRESET;
    interestCustomEl.value = '';
    interestRatePresetEl.dispatchEvent(new Event('change'));

    etfTypeEl.value = DEFAULT_ETF_TYPE;
    freibetragEl.value = DEFAULT_FREIBETRAG;
    steuerSatzEl.value = DEFAULT_STEUERSATZ;
    basiszinsEl.value = DEFAULT_BASISZINS;
    taxRateDisplayEl.textContent = DEFAULT_STEUERSATZ.toString();

    startEl.value = 0;
    stopMonthlyRateEnableEl.checked = false;
    stopMonthlyRateYearEl.value = 10;
    stopMonthlyRateEnableEl.dispatchEvent(new Event('change'));

    payoutYearTypeEl.value = 'laufjahr';

    lumpsumEntriesContainer.innerHTML = `
        <div class="row main-entry-row">
            <div><label for="lumpsum">Einmalige Einzahlung (‚Ç¨)</label><input id="lumpsum" type="number" value="0" min="0" class="lumpsum-amount"></div>
            <div><label for="lumpyear">Einmalige Einzahlung im Jahr (Laufjahr):</label><input id="lumpyear" type="number" value="1" min="1" class="lumpsum-year"></div>
        </div>`;

    oneTimePayoutEntriesContainer.innerHTML = `
        <div class="row main-entry-row">
            <div><label>Einmalige Auszahlung (‚Ç¨)</label><input id="payout" type="number" value="0" min="0" class="payout-amount"></div>
            <div><label>Auszahlung im Jahr:</label><input id="payoutYear" type="number" value="1" min="1" class="payout-year" placeholder="Jahr"></div>
        </div>`;

    payoutPlanAmountEl.value = 0;
    payoutStartYearEl.value = 1;
    payoutIntervalEl.value = 'monthly';
    payoutIntervalDaysEl.value = '';
    payoutIntervalEl.dispatchEvent(new Event('change'));

    chartAxisToggleEl.checked = false;
    warnEl.textContent = '';
    headlineEl.innerHTML = '';
    if (chartMain) {
        chartMain.destroy();
        chartMain = null;
    }
    if (chartCompare) {
        chartCompare.destroy();
        chartCompare = null;
    }

    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active-calc-btn'));
    document.querySelector('.btn[onclick="calc(false)"]').classList.add('active-calc-btn');

    updateCurrencyLabels(DEFAULT_CURRENCY);
    calc(false);
}

resetBtn.addEventListener('click', resetValuesAndCalc);

chartAxisToggleEl.addEventListener('change', () => {
    const activeCalcButton = document.querySelector('.btn-group .btn.active-calc-btn');
    const isNetto = activeCalcButton && activeCalcButton.textContent.includes('Netto');
    calc(isNetto);
});

assetToggleEls.forEach(cb => cb.addEventListener('change', () => {
    const activeCalcButton = document.querySelector('.btn-group .btn.active-calc-btn');
    const isNetto = activeCalcButton && activeCalcButton.textContent.includes('Netto');
    calc(isNetto);
}));

document.querySelectorAll('.btn-group .btn').forEach(button => {
    button.addEventListener('click', function() {
        document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active-calc-btn'));
        this.classList.add('active-calc-btn');
    });
});

function calc(withTax) {
  warnEl.textContent = '';
  const currency = currencyEl.value;

  // --- 1. Get all input values ---
  let baseMonthlyRate = parseFloat(rateEl.value) || 0;
  const monthlyRateIncrease = (parseFloat(monthlyRateIncreaseEl.value) || 0) / 100;
  const totalYears = parseInt(yearsEl.value) || 0;
  const investmentStartCalendarYear = parseInt(startCalendarYearEl.value) || new Date().getFullYear();
  let annualInterestRateValue = (interestRatePresetEl.value === 'custom') ? 
                                (parseFloat(interestCustomEl.value) || 0) : 
                                (parseFloat(interestRatePresetEl.value) || 0);
  const annualInterestRate = annualInterestRateValue / 100;
  const startCapital = parseFloat(startEl.value) || 0;
  const stopMonthlyRateEnabled = stopMonthlyRateEnableEl.checked;
  const stopMonthlyRateAtYear = parseInt(stopMonthlyRateYearEl.value) || 0;
  const currentEtfType = etfTypeEl.value;
  const currentFreibetrag = parseFloat(freibetragEl.value) || 0;
  const currentSteuerSatz = (parseFloat(steuerSatzEl.value) || 0) / 100;
  const currentBasiszins = (parseFloat(basiszinsEl.value) || 0) / 100;
  const globalPayoutYearType = payoutYearTypeEl.value;
  const allLumpsums = getDynamicEntries('lumpsum-amount', 'lumpsum-year');
  const allOneTimePayouts = getDynamicEntries('payout-amount', 'payout-year');
  const useCalendarYearAxis = chartAxisToggleEl.checked;
  const payoutPlanAmount = parseFloat(payoutPlanAmountEl.value) || 0;
  const payoutPlanStartYear = parseInt(payoutStartYearEl.value) || 0;
  const payoutPlanInterval = payoutIntervalEl.value;
  const payoutPlanIntervalDays = parseInt(payoutIntervalDaysEl.value) || 0;

  // --- 2. Validate inputs ---
  if (totalYears < 1) { warnEl.textContent = 'Bitte Laufzeit ‚â• 1 Jahr eingeben.'; return; }
  for (const payout of allOneTimePayouts) {
    let effectiveYear = payout.year;
    if (payout.yearType === 'kalenderjahr') {
        effectiveYear = payout.year - investmentStartCalendarYear + 1;
    }
    if (effectiveYear < 1 || effectiveYear > totalYears) {
        warnEl.textContent = `Auszahlung im Jahr ${payout.year} liegt au√üerhalb der Laufzeit.`;
        return;
    }
  }


  // --- 3. Initialize calculation variables ---
  let balance = startCapital; 
  let cumulativeGrossDeposits = startCapital; 
  let cumulativeTotalPayouts = 0;
  let cumulativeTotalTax = 0; 
  let freibetragRestJahr = currentFreibetrag; 
  let allVPAsPaid = 0;

  const labels = [];
  const chartNetDepositsData = []; 
  const chartNetGainData = [];     
  const chartAnnualPayoutsData = []; 
  const chartCumulativeTaxData = []; 


  // --- 4. Loop through each year of the investment period ---
  for (let y = 1; y <= totalYears; y++) {
    const currentCalendarYear = investmentStartCalendarYear + y - 1;
    let yearlyPayoutSum = 0; 
    let balanceAtStartOfYear = balance; 
    let yearlyTax = 0;
    
    if (y > 1) { 
        freibetragRestJahr = currentFreibetrag;
        baseMonthlyRate *= (1 + monthlyRateIncrease); 
    }

    allLumpsums.forEach(lump => {
        if (lump.year === y) { 
            balance += lump.amount; 
            cumulativeGrossDeposits += lump.amount; 
            balanceAtStartOfYear += lump.amount; 
        }
    });

    let annualContributions = 0;
    if (!(stopMonthlyRateEnabled && y >= stopMonthlyRateAtYear)) {
        annualContributions = baseMonthlyRate * 12;
    }
    balance += annualContributions;
    cumulativeGrossDeposits += annualContributions;
    
    const balanceBeforeInterestThisYear = balance;
    balance *= (1 + annualInterestRate);
    const wertsteigerungDiesesJahr = balance - balanceBeforeInterestThisYear;
    
    allOneTimePayouts.forEach(payout => {
        let payoutOccursThisYear = (globalPayoutYearType === 'laufjahr' && payout.year === y) ||
                                 (globalPayoutYearType === 'kalenderjahr' && payout.year === currentCalendarYear);
        if (payoutOccursThisYear) {
            const actualPayoutAmount = Math.min(balance, payout.amount); 
            balance -= actualPayoutAmount; 
            cumulativeTotalPayouts += actualPayoutAmount;
            yearlyPayoutSum += actualPayoutAmount;
        }
    });

    if (y >= payoutPlanStartYear && payoutPlanAmount > 0) {
      let yearlyEquivalentPayout = 0;
      if (payoutPlanInterval === 'yearly') yearlyEquivalentPayout = payoutPlanAmount;
      else if (payoutPlanInterval === 'custom' && payoutPlanIntervalDays > 0) yearlyEquivalentPayout = payoutPlanAmount * (365 / payoutPlanIntervalDays);
      else if (payoutPlanInterval === 'monthly') yearlyEquivalentPayout = payoutPlanAmount * 12;
      
      const actualYearlyEquivalentPayout = Math.min(balance, yearlyEquivalentPayout);
      balance -= actualYearlyEquivalentPayout; 
      cumulativeTotalPayouts += actualYearlyEquivalentPayout;
      yearlyPayoutSum += actualYearlyEquivalentPayout;
    }
    
    if (withTax) {
        if (currentEtfType === 'thesaurierend') {
            const vorabpauschaleRoh = balanceAtStartOfYear * currentBasiszins * 0.7;
            const anzusetzenderErtragFuerVPA = Math.min(vorabpauschaleRoh, wertsteigerungDiesesJahr);
            allVPAsPaid += anzusetzenderErtragFuerVPA;
            const zuVersteuernVPA = Math.max(0, anzusetzenderErtragFuerVPA - freibetragRestJahr);
            yearlyTax = zuVersteuernVPA * currentSteuerSatz;
            freibetragRestJahr -= Math.min(anzusetzenderErtragFuerVPA, freibetragRestJahr);
        } else { // 'aussch√ºttend'
            const zuVersteuern = Math.max(0, wertsteigerungDiesesJahr - freibetragRestJahr);
            yearlyTax = zuVersteuern * currentSteuerSatz;
            freibetragRestJahr -= Math.min(wertsteigerungDiesesJahr, freibetragRestJahr);
        }
        yearlyTax = Math.max(0, yearlyTax);
        balance -= yearlyTax; 
        cumulativeTotalTax += yearlyTax;
    }
    
    labels.push(useCalendarYearAxis ? currentCalendarYear.toString() : 'Jahr ' + y);
    const netInvestedCapitalForYear = cumulativeGrossDeposits - cumulativeTotalPayouts;
    chartNetDepositsData.push(Math.max(0, netInvestedCapitalForYear));
    chartNetGainData.push(Math.max(0, balance - netInvestedCapitalForYear));
    chartAnnualPayoutsData.push(-yearlyPayoutSum); 
    chartCumulativeTaxData.push(cumulativeTotalTax); 
  }

  const finalBalance = balance; 
  const finalNetInvested = cumulativeGrossDeposits - cumulativeTotalPayouts;
  const finalTotalGain = finalBalance - finalNetInvested; 
  
  let verkaufsteuer = 0;
  let endkapitalNachVerkaufsteuer = finalBalance;

  let headlineHTML = `
    <div class="headline-item"><span class="headline-label">Brutto-Einzahlungen:</span> <span class="headline-sub-value">${fmt(cumulativeGrossDeposits, currency)}</span></div>
    <div class="headline-item"><span class="headline-label">Gesamter Gewinn ${withTax ? '(Netto vor Verkauf)' : '(Brutto)'}:</span> <span class="headline-value">${fmt(finalTotalGain, currency)}</span></div>
    <div class="headline-item"><span class="headline-label">Auszahlungen (kumuliert):</span> <span class="headline-sub-value">${fmt(cumulativeTotalPayouts, currency)}</span></div>`;

  if (withTax) {
    const totalGainOnSale = finalBalance - (cumulativeGrossDeposits - allVPAsPaid - cumulativeTotalPayouts);
    const taxableGainOnSale = Math.max(0, totalGainOnSale - currentFreibetrag);
    verkaufsteuer = taxableGainOnSale * currentSteuerSatz * 0.7;
    verkaufsteuer = Math.max(0, verkaufsteuer);
    endkapitalNachVerkaufsteuer = finalBalance - verkaufsteuer;

    headlineHTML += `<div class="headline-item"><span class="headline-label">Verkaufsteuer (hypothetisch):</span> <span class="headline-sub-value">${fmt(verkaufsteuer, currency)} <button type="button" class="info-btn" data-modal-target="modalVerkaufsteuerInfo" title="Info zur Verkaufsteuer">?</button></span></div>`;
    headlineHTML += `<div class="headline-item"><span class="headline-label">Endkapital (nach Verkaufsteuer):</span> <span class="headline-value">${fmt(endkapitalNachVerkaufsteuer, currency)}</span></div>`;
  } else {
    headlineHTML += `<div class="headline-item"><span class="headline-label">Endkapital:</span> <span class="headline-value">${fmt(finalBalance, currency)}</span></div>`;
  }
  headlineEl.innerHTML = headlineHTML;
  document.querySelectorAll('[data-modal-target="modalVerkaufsteuerInfo"]').forEach(button => {
        if(button.getAttribute('listener') !== 'true'){ 
            button.addEventListener('click', () => openModal('modalVerkaufsteuerInfo'));
            button.setAttribute('listener', 'true');
        }
  });

  const chartOptionsBase = { 
    responsive: true,
    maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
        tooltip: {
            callbacks: {
                label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) label += ': ';
                    const value = context.dataset.label === 'Auszahlungen (j√§hrlich)' ? Math.abs(context.parsed.y) : context.parsed.y;
                    label += fmt(value, currency);
                    return label;
                }
            }
        }
    },
    layout: { padding: { top: 20, bottom:10, left:10, right:10 } } 
  };

  if (chartMain) chartMain.destroy();
  const datasetsMain = [
    { label: 'Netto Einzahlungen', data: chartNetDepositsData, backgroundColor: CAPITAL_COLOR, stack: 'positiveStack' },
    { label: `Gewinn ${withTax ? '(Netto)' : '(Brutto)'}`, data: chartNetGainData, backgroundColor: GAIN_COLOR, stack: 'positiveStack' },
    { label: 'Auszahlungen (j√§hrlich)', data: chartAnnualPayoutsData, backgroundColor: ANNUAL_PAYOUT_COLOR, stack: 'negativeStack' }
  ];
  if (withTax) { 
      datasetsMain.push({
          label: 'Steuer (kumuliert)', data: chartCumulativeTaxData, backgroundColor: TAX_COLOR_DIAGRAM, type: 'line', order: -1, yAxisID: 'y1'
      });
  }
  chartMain = new Chart(document.getElementById('chart').getContext('2d'), {
    type: 'bar', 
    data: { labels: labels, datasets: datasetsMain },
    options: {
        ...chartOptionsBase,
        scales: { 
            y: { stacked: true, title: { display: true, text: `Betrag (${currency.toUpperCase()})`}, beginAtZero: true }, 
            y1: { display: withTax, position: 'right', title: {display: true, text: 'Steuer kumuliert'}, grid: {drawOnChartArea: false} },
            x: { stacked: true, title: { display: true, text: useCalendarYearAxis ? 'Kalenderjahr' : 'Laufjahre'} } 
        }
    }
  });

  const etfGesamtwertentwicklung = finalBalance + cumulativeTotalPayouts;
  const baseMonthly = parseFloat(rateEl.value) || 0;

  const tdTotal = computeComparisonTotal(startCapital, allLumpsums, baseMonthly, monthlyRateIncrease, 0.02, totalYears, stopMonthlyRateEnabled, stopMonthlyRateAtYear);
  const btcTotal = computeComparisonTotal(startCapital, allLumpsums, baseMonthly, monthlyRateIncrease, 0.45, totalYears, stopMonthlyRateEnabled, stopMonthlyRateAtYear);
  const ethTotal = computeComparisonTotal(startCapital, allLumpsums, baseMonthly, monthlyRateIncrease, 0.30, totalYears, stopMonthlyRateEnabled, stopMonthlyRateAtYear);

  updateCompareChart(etfGesamtwertentwicklung, tdTotal, cumulativeGrossDeposits, btcTotal, ethTotal, currency);
}

document.addEventListener('DOMContentLoaded', () => {
    resetValuesAndCalc();
});
</script>
</body>
</html>
